name: RDP with Tailscale

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget net-tools iproute2

      - name: Install & Start Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo systemctl enable --now tailscaled
          HOSTNAME="zhameng-$(date +%s)"
          echo "HOSTNAME=$HOSTNAME" >> $GITHUB_ENV
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=$HOSTNAME --accept-routes
          sudo tailscale status

      - name: Get Tailscale IP
        id: tailscale-ip
        run: |
          TAILSCALE_IP=$(sudo tailscale ip -4 || true)
          if [ -z "$TAILSCALE_IP" ]; then
            TAILSCALE_IP=$(ip addr show tailscale0 2>/dev/null | grep -oP 'inet \K[\d.]+' || echo "unknown")
          fi
          echo "ip=$TAILSCALE_IP" >> $GITHUB_OUTPUT

      - name: Setup RDP User
        run: |
          USERNAME="zhameng"
          PASSWORD='Fardan123@'
          if id "$USERNAME" &>/dev/null; then
            echo "$USERNAME:$PASSWORD" | sudo chpasswd
          else
            sudo useradd -m -s /bin/bash $USERNAME
            echo "$USERNAME:$PASSWORD" | sudo chpasswd
            sudo usermod -aG sudo $USERNAME
          fi
          echo "xfce4-session" | sudo tee /home/$USERNAME/.xsession
          sudo chown -R $USERNAME:$USERNAME /home/$USERNAME
          sudo chmod +x /home/$USERNAME/.xsession

      - name: Install XRDP and Desktop Environment
        run: |
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get install -y \
            xrdp \
            xfce4 \
            xfce4-goodies \
            firefox \
            fonts-noto \
            dbus-x11 \
            pulseaudio

          sudo sed -i 's/allow_root=true/allow_root=false/g' /etc/xrdp/xrdp.ini

          cat << 'EOF' | sudo tee /etc/xrdp/startwm.sh
          #!/bin/sh
          if [ -r /etc/default/locale ]; then
            . /etc/default/locale
            export LANG LANGUAGE
          fi
          startxfce4
          EOF
          sudo chmod +x /etc/xrdp/startwm.sh
          echo 'xfce4-session' > ~/.xsession

      - name: Configure and Start Services
        run: |
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp
          sudo netstat -tlnp | grep :3389 || echo "XRDP not listening on 3389"
          if command -v ufw >/dev/null 2>&1; then
            sudo ufw allow 3389
          fi

      - name: Display Connection Information
        run: |
          echo "üñ•Ô∏è  ========== RDP CONNECTION INFO ========== üñ•Ô∏è"
          echo "üîó Hostname: $HOSTNAME"
          echo "üîó IP: ${{ steps.tailscale-ip.outputs.ip }}"
          echo "üë§ User: zhameng"
          echo "üîë Pass: Fardan123@"
          echo "Port: 3389"
          echo "================================================="
          sudo tailscale status

      - name: Keep Alive
        run: |
          echo "RDP session active (max 6h)..."
          sleep 21600
